# 朋友圈删除功能实现说明

## 功能需求
为朋友圈添加选择删除功能，包括：
1. 进入选择模式后显示复选框
2. 全选/取消全选按钮
3. 删除选中的朋友圈
4. 可以手动取消单个选中项

## 实现步骤

### 1. 在 FriendsCircle 类中添加选择相关方法

在 `app/friends-circle.js` 文件的 `FriendsCircle` 类中添加以下方法（在 `constructor` 之后添加）：

```javascript
/**
 * 进入选择模式
 */
enterSelectionMode() {
  this.isSelectionMode = true;
  this.selectedCircles.clear();
  this.updateHeader();
  this.dispatchUpdateEvent();
  console.log('[Friends Circle] 进入选择模式');
}

/**
 * 退出选择模式
 */
exitSelectionMode() {
  this.isSelectionMode = false;
  this.selectedCircles.clear();
  this.updateHeader();
  this.dispatchUpdateEvent();
  console.log('[Friends Circle] 退出选择模式');
}

/**
 * 切换单个朋友圈的选择状态
 * @param {string} circleId - 朋友圈ID
 */
toggleCircleSelection(circleId) {
  if (this.selectedCircles.has(circleId)) {
    this.selectedCircles.delete(circleId);
  } else {
    this.selectedCircles.add(circleId);
  }
  
  // 直接更新DOM复选框状态，避免重新渲染整个页面
  const checkbox = document.querySelector(`.circle-checkbox[data-circle-id="${circleId}"]`);
  if (checkbox) {
    checkbox.checked = this.selectedCircles.has(circleId);
  }
  
  // 更新选择计数显示
  this.updateSelectionCount();
}

/**
 * 全选/取消全选
 */
toggleSelectAll() {
  const allCircles = this.manager.getSortedFriendsCircles();
  
  if (this.selectedCircles.size === allCircles.length) {
    // 当前已全选，执行取消全选
    this.selectedCircles.clear();
  } else {
    // 执行全选
    allCircles.forEach(circle => this.selectedCircles.add(circle.id));
  }
  
  // 更新所有复选框状态
  document.querySelectorAll('.circle-checkbox').forEach(checkbox => {
    const circleId = checkbox.dataset.circleId;
    checkbox.checked = this.selectedCircles.has(circleId);
  });
  
  this.updateSelectionCount();
}

/**
 * 更新选择计数显示
 */
updateSelectionCount() {
  const countElement = document.querySelector('.selection-count');
  if (countElement) {
    countElement.textContent = `已选择 ${this.selectedCircles.size} 条`;
  }
}

/**
 * 删除选中的朋友圈
 */
deleteSelected() {
  if (this.selectedCircles.size === 0) {
    this.showToast('请先选择要删除的朋友圈', 'warning');
    return;
  }
  
  const count = this.selectedCircles.size;
  
  if (!confirm(`确定要删除 ${count} 条朋友圈吗？此操作不可恢复。`)) {
    return;
  }
  
  try {
    // 保存当前滚动位置
    const contentElement = document.querySelector('.friends-circle-content');
    const scrollPos = contentElement ? contentElement.scrollTop : 0;
    
    // 删除选中的朋友圈数据
    this.selectedCircles.forEach(circleId => {
      this.manager.friendsCircleData.delete(circleId);
      console.log(`[Friends Circle] 删除朋友圈: ${circleId}`);
    });
    
    // 退出选择模式
    this.exitSelectionMode();
    
    // 恢复滚动位置
    setTimeout(() => {
      const content = document.querySelector('.friends-circle-content');
      if (content) {
        content.scrollTop = scrollPos;
      }
    }, 100);
    
    this.showToast(`成功删除 ${count} 条朋友圈`, 'success');
    
  } catch (error) {
    console.error('[Friends Circle] 删除失败:', error);
    this.showToast('删除失败，请重试', 'error');
  }
}
```

### 2. 修改 updateHeader 方法

找到 `updateHeader()` 方法，替换为以下代码：

```javascript
/**
 * 更新朋友圈header
 */
updateHeader() {
  console.log('[Friends Circle] 更新朋友圈header...');

  if (window.mobilePhone) {
    const friendsCircleState = {
      app: 'messages',
      view: 'friendsCircle',
      title: this.isSelectionMode ? '选择朋友圈' : '朋友圈',
      showBackButton: this.isSelectionMode,
      backButtonAction: () => {
        if (this.isSelectionMode) {
          this.exitSelectionMode();
        }
      },
      showAddButton: true,
      addButtonIcon: this.isSelectionMode ? 'fas fa-check-square' : 'fas fa-plus',
      addButtonAction: () => {
        if (this.isSelectionMode) {
          this.toggleSelectAll();
        } else {
          this.showPublishModal();
        }
      },
    };

    window.mobilePhone.currentAppState = friendsCircleState;
    window.mobilePhone.updateAppHeader(friendsCircleState);
    console.log('[Friends Circle] Header更新完成');
  } else {
    console.warn('[Friends Circle] mobilePhone不存在，无法更新header');
  }
}
```

### 3. 修改 renderCirclesList 方法

找到 `FriendsCircleRenderer` 类中的 `renderCirclesList()` 方法，在返回的 HTML 最前面添加选择工具栏：

```javascript
renderCirclesList() {
  if (!this.friendsCircle.manager) {
    return '<div class="empty-circles"><i class="fas fa-heart"></i><span>暂无朋友圈</span></div>';
  }

  const circles = this.friendsCircle.manager.getSortedFriendsCircles();

  if (circles.length === 0) {
    return '<div class="empty-circles"><i class="fas fa-heart"></i><span>暂无朋友圈</span></div>';
  }

  // 同步批量获取基础信息
  try {
    this.friendsCircle.batchGetBasicInfo();
  } catch (error) {
    console.warn('[Friends Circle] 批量获取基础信息失败，使用降级处理:', error);
  }

  // 只渲染前10条朋友圈
  const visibleCircles = circles.slice(0, 10);
  const remainingCount = circles.length - 10;

  // 添加选择工具栏（仅在选择模式下显示）
  let toolbarHtml = '';
  if (this.friendsCircle.isSelectionMode) {
    toolbarHtml = `
      <div class="selection-toolbar">
        <div class="selection-info">
          <span class="selection-count">已选择 ${this.friendsCircle.selectedCircles.size} 条</span>
        </div>
        <div class="selection-actions">
          <button class="selection-btn select-all-btn" onclick="window.friendsCircle?.toggleSelectAll()">
            <i class="fas fa-check-square"></i>
            全选
          </button>
          <button class="selection-btn delete-btn" onclick="window.friendsCircle?.deleteSelected()">
            <i class="fas fa-trash"></i>
            删除
          </button>
          <button class="selection-btn cancel-btn" onclick="window.friendsCircle?.exitSelectionMode()">
            <i class="fas fa-times"></i>
            取消
          </button>
        </div>
      </div>
    `;
  } else {
    // 非选择模式下显示进入选择模式的按钮
    toolbarHtml = `
      <div class="action-toolbar">
        <button class="action-btn enter-selection-btn" onclick="window.friendsCircle?.enterSelectionMode()">
          <i class="fas fa-check-square"></i>
          选择删除
        </button>
      </div>
    `;
  }

  let html = toolbarHtml + visibleCircles.map(circle => this.renderSingleCircle(circle)).join('');

  // 如果还有更多朋友圈，添加加载更多按钮
  if (remainingCount > 0) {
    html += `
      <div class="load-more-container" data-remaining="${remainingCount}" style="text-align: center; padding: 20px;">
        <button class="load-more-btn" onclick="window.friendsCircle.loadMoreCircles()"
                style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 20px; cursor: pointer; font-size: 14px;">
          <i class="fas fa-chevron-down" style="margin-right: 5px;"></i>
          加载更多 (还有${remainingCount}条)
        </button>
      </div>
    `;
  }

  return html;
}
```

### 4. 修改 renderSingleCircle 方法

找到 `renderSingleCircle()` 方法，在 `circle-header` 部分添加复选框：

```javascript
renderSingleCircle(circle) {
  // 获取头像等信息...
  let friendAvatar;
  const cache = this.friendsCircle.batchCache;
  const currentUserName = cache.userName || this.getCurrentUserName();

  if (circle.author === currentUserName || circle.friendId === '483920') {
    friendAvatar = cache.userAvatar || this.getCurrentUserAvatar();
  } else {
    friendAvatar = cache.friendAvatars.get(circle.friendId) || this.getFriendAvatar(circle.friendId);
  }

  const timeStr = this.formatTime(circle.messageIndex || 0);
  const contentHtml = this.renderCircleContent(circle);
  const repliesHtml = this.renderCircleReplies(circle.replies, circle.id);
  const actionsHtml = this.renderCircleActions(circle);

  // 判断是否选中
  const isSelected = this.friendsCircle.selectedCircles.has(circle.id);

  return `
    <div class="circle-item ${this.friendsCircle.isSelectionMode ? 'selection-mode' : ''}" 
         data-circle-id="${circle.id}">
      <div class="circle-header">
        ${this.friendsCircle.isSelectionMode ? `
          <div class="circle-checkbox-container">
            <input type="checkbox" 
                   class="circle-checkbox" 
                   data-circle-id="${circle.id}"
                   ${isSelected ? 'checked' : ''}
                   onchange="window.friendsCircle?.toggleCircleSelection('${circle.id}')">
          </div>
        ` : ''}
        <div class="friend-avatar">
          <img src="${friendAvatar}" alt="${circle.author}" />
        </div>
        <div class="friend-info">
          <div class="friend-name">${circle.author}</div>
          <div class="circle-time">${timeStr}</div>
        </div>
      </div>

      <div class="circle-content">
        ${contentHtml}
      </div>

      <div class="circle-actions">
        ${actionsHtml}
      </div>

      ${repliesHtml}

      <div class="reply-input-container" id="reply-input-${circle.id}" style="display: none;">
        <input type="text" class="reply-input" placeholder="写下你的想法..." />
        <button class="reply-send-btn" onclick="window.friendsCircle?.sendCircleReply('${circle.id}')">
          <i class="fas fa-paper-plane"></i>
        </button>
      </div>
    </div>
  `;
}
```

### 5. 添加 CSS 样式

在 `app/friends-circle.css` 文件中添加以下样式（如果没有这个文件，在主 CSS 文件中添加）：

```css
/* 选择工具栏样式 */
.selection-toolbar {
  position: sticky;
  top: 0;
  background: #fff;
  padding: 10px 15px;
  border-bottom: 1px solid #e0e0e0;
  display: flex;
  justify-content: space-between;
  align-items: center;
  z-index: 100;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.selection-info {
  display: flex;
  align-items: center;
}

.selection-count {
  font-size: 14px;
  color: #666;
  font-weight: 500;
}

.selection-actions {
  display: flex;
  gap: 8px;
}

.selection-btn {
  padding: 6px 12px;
  border: none;
  border-radius: 4px;
  font-size: 13px;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 5px;
  transition: all 0.3s;
}

.select-all-btn {
  background: #007bff;
  color: white;
}

.select-all-btn:hover {
  background: #0056b3;
}

.delete-btn {
  background: #dc3545;
  color: white;
}

.delete-btn:hover {
  background: #c82333;
}

.cancel-btn {
  background: #6c757d;
  color: white;
}

.cancel-btn:hover {
  background: #545b62;
}

/* 非选择模式的操作工具栏 */
.action-toolbar {
  padding: 10px 15px;
  display: flex;
  justify-content: flex-end;
}

.action-btn {
  padding: 8px 16px;
  border: 1px solid #007bff;
  background: white;
  color: #007bff;
  border-radius: 20px;
  font-size: 14px;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 6px;
  transition: all 0.3s;
}

.action-btn:hover {
  background: #007bff;
  color: white;
}

/* 复选框容器 */
.circle-checkbox-container {
  display: flex;
  align-items: center;
  justify-content: center;
  margin-right: 10px;
}

.circle-checkbox {
  width: 20px;
  height: 20px;
  cursor: pointer;
  accent-color: #007bff;
}

/* 选择模式下的朋友圈项 */
.circle-item.selection-mode {
  background: #f8f9fa;
  border-left: 3px solid transparent;
  transition: all 0.3s;
}

.circle-item.selection-mode .circle-checkbox:checked ~ * {
  opacity: 0.7;
}

/* 朋友圈头部在选择模式下的调整 */
.circle-item.selection-mode .circle-header {
  display: flex;
  align-items: center;
}
```

## 测试步骤

1. 在朋友圈页面点击"选择删除"按钮进入选择模式
2. 点击复选框选择要删除的朋友圈
3. 点击右上角"全选"按钮测试全选功能
4. 再次点击"全选"测试取消全选
5. 手动选择几条朋友圈，然后取消某一条的选中
6. 点击"删除"按钮，确认删除提示
7. 确认删除后，检查朋友圈是否被正确删除
8. 点击"取消"按钮退出选择模式

## 注意事项

1. 删除的朋友圈数据只是从前端删除，不会影响服务器数据
2. 页面刷新后删除的数据可能会重新加载（如果从服务器获取）
3. 如果需要永久删除，需要配合后端API实现
4. 删除操作不可恢复，建议添加二次确认
5. 选择模式下header的"+"按钮变为"全选"按钮，返回按钮用于退出选择模式

## 可选优化

1. 添加批量操作的加载动画
2. 添加删除动画效果（淡出效果）
3. 支持长按朋友圈进入选择模式
4. 添加"反选"功能
5. 在删除前显示选中项预览
6. 支持滑动删除单个朋友圈
7. 添加删除统计（今日删除、总共删除等）
8. 支持撤销删除（需要实现回收站功能）

## 相关文件

- `app/friends-circle.js` -
