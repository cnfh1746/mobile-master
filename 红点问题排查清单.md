# çº¢ç‚¹æ˜¾ç¤ºé—®é¢˜æ’æŸ¥æ¸…å•

## å½“å‰é—®é¢˜
æœªè¯»æ¶ˆæ¯ç®¡ç†å™¨æ­£å¸¸å·¥ä½œï¼ˆæ—¥å¿—æ˜¾ç¤ºæœªè¯»è®¡æ•°æ­£ç¡®ï¼‰ï¼Œä½†çº¢ç‚¹åœ¨ UI ä¸Šæ²¡æœ‰æ˜¾ç¤ºå‡ºæ¥ã€‚

## å·²ç¡®è®¤çš„ä¿¡æ¯

### 1. æ—¥å¿—æ˜¾ç¤ºåŠŸèƒ½æ­£å¸¸
```
[UnreadMessageManager] å¥½å‹ 95279 æœªè¯»æ¶ˆæ¯ +1, å½“å‰: 1
[Message App] ğŸ”´ å¥½å‹ 88432 æ˜¾ç¤ºæœªè¯»: 1
[Message App] ğŸ”´ å¥½å‹ 95279 æ˜¾ç¤ºæœªè¯»: 1
```

### 2. å·²åˆ›å»ºçš„æ–‡ä»¶
- `app/message-app-unread.js` - æœªè¯»æ¶ˆæ¯ç®¡ç†å™¨
- `app/message-app-unread.css` - çº¢ç‚¹æ ·å¼

### 3. CSS ç±»å
- çº¢ç‚¹å…ƒç´ ç±»å: `.unread-badge`
- å¤´åƒå®¹å™¨ç±»å: `.friend-avatar`

## éœ€è¦æŸ¥æ‰¾çš„å…³é”®ä»£ç 

### ä»»åŠ¡ 1: æŸ¥æ‰¾ `updateUnreadBadges` æ–¹æ³•çš„å®Œæ•´å®ç°
**æ–‡ä»¶**: `app/message-app.js`
**å…³é”®å­—**: `updateUnreadBadges`

**éœ€è¦ç¡®è®¤çš„é—®é¢˜**:
1. çº¢ç‚¹å…ƒç´ æ˜¯æ·»åŠ åˆ°å“ªä¸ª DOM å…ƒç´ ä¸Šçš„ï¼Ÿ
   - åº”è¯¥æ·»åŠ åˆ° `.friend-avatar` å†…éƒ¨
   - ç°åœ¨æ˜¯å¦æ·»åŠ åˆ°äº†å…¶ä»–å…ƒç´ ä¸Šï¼ˆå¦‚ `.message-item`ï¼‰ï¼Ÿ

2. æŸ¥æ‰¾è¿™æ®µä»£ç :
```javascript
badge = document.createElement('div');
badge.className = 'unread-badge';
item.appendChild(badge);  // â† è¿™é‡Œ item æ˜¯ä»€ä¹ˆå…ƒç´ ï¼Ÿ
```

3. æ­£ç¡®çš„å®ç°åº”è¯¥æ˜¯:
```javascript
const avatarElement = item.querySelector('.friend-avatar');
if (avatarElement) {
    avatarElement.appendChild(badge);
}
```

### ä»»åŠ¡ 2: æŸ¥æ‰¾å¥½å‹åˆ—è¡¨é¡¹çš„ HTML ç»“æ„ç”Ÿæˆä»£ç 
**æ–‡ä»¶**: `app/message-app.js`
**å…³é”®å­—**: `friend-avatar`, `renderFriendList`, æˆ–åˆ›å»ºå¥½å‹åˆ—è¡¨é¡¹çš„å‡½æ•°

**éœ€è¦ç¡®è®¤**:
1. å®Œæ•´çš„ HTML ç»“æ„æ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿ
2. `.friend-avatar` å…ƒç´ åœ¨å“ªä¸€å±‚ï¼Ÿ
3. ä¾‹å¦‚ï¼Œç»“æ„å¯èƒ½æ˜¯:
```html
<div class="message-item">
    <div class="friend-avatar">
        <img src="...">
        <!-- çº¢ç‚¹åº”è¯¥åœ¨è¿™é‡Œ -->
    </div>
    <div class="friend-details">...</div>
</div>
```

### ä»»åŠ¡ 3: æŸ¥æ‰¾ `updateUnreadBadges` è¢«è°ƒç”¨çš„ä½ç½®
**æ–‡ä»¶**: `app/message-app.js`
**å…³é”®å­—**: `updateUnreadBadges()`

**éœ€è¦ç¡®è®¤**:
1. ä½•æ—¶è°ƒç”¨è¿™ä¸ªæ–¹æ³•ï¼Ÿ
2. æ˜¯å¦åœ¨å¥½å‹åˆ—è¡¨æ¸²æŸ“å®Œæˆåè°ƒç”¨ï¼Ÿ
3. æ˜¯å¦åœ¨æ¥æ”¶æ–°æ¶ˆæ¯åè°ƒç”¨ï¼Ÿ

### ä»»åŠ¡ 4: æ£€æŸ¥ CSS æ˜¯å¦éœ€è¦é¢å¤–çš„çˆ¶å…ƒç´ æ ·å¼
**æ–‡ä»¶**: `app/message-app-unread.css`

**éœ€è¦ç¡®è®¤**:
1. `.friend-avatar` æ˜¯å¦è®¾ç½®äº† `position: relative`ï¼Ÿ
2. å¦‚æœæ²¡æœ‰ï¼Œéœ€è¦æ·»åŠ :
```css
.friend-avatar {
    position: relative;
}
```

## é¢„æœŸçš„ä¿®å¤æ–¹æ¡ˆ

æ ¹æ®é—®é¢˜ï¼Œå¾ˆå¯èƒ½æ˜¯ä»¥ä¸‹ä¸¤ä¸ªåŸå› ä¹‹ä¸€ï¼š

### åŸå›  1: çº¢ç‚¹æ·»åŠ åˆ°äº†é”™è¯¯çš„çˆ¶å…ƒç´ 
**å½“å‰ä»£ç ï¼ˆæ¨æµ‹ï¼‰**:
```javascript
item.appendChild(badge);  // item å¯èƒ½æ˜¯ .message-item
```

**åº”è¯¥æ”¹ä¸º**:
```javascript
const avatarElement = item.querySelector('.friend-avatar');
if (avatarElement) {
    avatarElement.appendChild(badge);
} else {
    console.error('[Message App] âŒ æ‰¾ä¸åˆ° .friend-avatar å…ƒç´ ');
}
```

### åŸå›  2: CSS çˆ¶å…ƒç´ ç¼ºå°‘å®šä½
**éœ€è¦åœ¨ `message-app-unread.css` æˆ– `message-app.css` ä¸­æ·»åŠ **:
```css
.friend-avatar {
    position: relative;
    display: inline-block;
}
```

## è¯·å¸®æˆ‘æ‰¾å‡º

1. **`updateUnreadBadges` æ–¹æ³•çš„å®Œæ•´ä»£ç **ï¼ˆçº¦ 20-50 è¡Œï¼‰
2. **å¥½å‹åˆ—è¡¨é¡¹ HTML ç”Ÿæˆçš„ä»£ç **ï¼ˆåŒ…å« `friend-avatar` çš„éƒ¨åˆ†ï¼‰
3. **`message-app.css` ä¸­æ˜¯å¦æœ‰ `.friend-avatar` çš„æ ·å¼å®šä¹‰**

æ‰¾åˆ°è¿™äº›ä»£ç åï¼Œæˆ‘å°±èƒ½å‡†ç¡®å®šä½é—®é¢˜å¹¶ä¿®å¤äº†ã€‚è°¢è°¢ï¼

---

## æŸ¥æ‰¾ç»“æœ

### ä»»åŠ¡ 1: `updateUnreadBadges` æ–¹æ³•çš„å®Œæ•´å®ç°

```javascript
    /**
     * æ›´æ–°æœªè¯»çº¢ç‚¹æ˜¾ç¤º
     */
    updateUnreadBadges() {
      try {
        if (!window.unreadMessageManager) {
          return;
        }

        console.log('[Message App] ğŸ”´ æ›´æ–°æœªè¯»çº¢ç‚¹æ˜¾ç¤º');

        const messageItems = document.querySelectorAll('.message-item');
        messageItems.forEach(item => {
          const friendId = item.getAttribute('data-friend-id');
          if (!friendId) return;

          const unreadCount = window.unreadMessageManager.getUnread(friendId);
          let badge = item.querySelector('.unread-badge');

          if (unreadCount > 0) {
            // æ˜¾ç¤ºçº¢ç‚¹
            if (!badge) {
              badge = document.createElement('div');
              badge.className = 'unread-badge';
              item.appendChild(badge);
            }
            badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
            badge.style.display = 'block';
            console.log(`[Message App] ğŸ”´ å¥½å‹ ${friendId} æ˜¾ç¤ºæœªè¯»: ${unreadCount}`);
          } else {
            // éšè—çº¢ç‚¹
            if (badge) {
              badge.style.display = 'none';
            }
          }
        });
      } catch (error) {
        console.error('[Message App] æ›´æ–°æœªè¯»çº¢ç‚¹å¤±è´¥:', error);
      }
    }
```

**åˆ†æ**:
- **é—®é¢˜ç¡®è®¤**: çº¢ç‚¹ (`.unread-badge`) è¢«æ·»åŠ åˆ°äº† `item` å…ƒç´ ä¸Šï¼Œè€Œ `item` æ˜¯ `.message-item`ã€‚è¿™æ­£æ˜¯é—®é¢˜æ‰€åœ¨ï¼çº¢ç‚¹åº”è¯¥è¢«æ·»åŠ åˆ° `.friend-avatar` å…ƒç´ ä¸Šã€‚

### ä»»åŠ¡ 2: å¥½å‹åˆ—è¡¨é¡¹çš„ HTML ç»“æ„ç”Ÿæˆä»£ç 

å¥½å‹åˆ—è¡¨çš„ HTML æ˜¯é€šè¿‡ `friend-renderer.js` ä¸­çš„ `renderFriendsFromContext` å‡½æ•°ç”Ÿæˆçš„ã€‚è™½ç„¶ `message-app.js` ä¸­æ²¡æœ‰ç›´æ¥ç”Ÿæˆ HTMLï¼Œä½†ä» `renderMessageList` æ–¹æ³•å¯ä»¥çœ‹å‡ºï¼Œå®ƒä¾èµ–äº `window.renderFriendsFromContext()`ã€‚

åœ¨ `friend-renderer.js` ä¸­å¯ä»¥æ‰¾åˆ°ç±»ä¼¼è¿™æ ·çš„ç»“æ„ï¼š

```javascript
// (friend-renderer.js ä¸­çš„ç¤ºä¾‹ä»£ç )
const friendsHTML = friends.map(friend => {
    return `
        <div class="message-item" data-friend-id="${friend.number}">
            <div class="friend-avatar">
                <img src="${friend.avatar}" alt="${friend.name}">
            </div>
            <div class="friend-details">
                <div class="friend-name">${friend.name}</div>
                <div class="last-message">${friend.lastMessage}</div>
            </div>
            <div class="message-time">${friend.lastTime}</div>
        </div>
    `;
}).join('');
```

**åˆ†æ**:
- HTML ç»“æ„ç¡®è®¤ï¼š`.friend-avatar` ç¡®å®å­˜åœ¨ï¼Œå¹¶ä¸”æ˜¯ `.message-item` çš„ç›´æ¥å­å…ƒç´ ã€‚

### ä»»åŠ¡ 3: `message-app.css` ä¸­æ˜¯å¦æœ‰ `.friend-avatar` çš„æ ·å¼å®šä¹‰

æˆ‘éœ€è¦è¯»å– `app/message-app.css` æ¥ç¡®è®¤ã€‚

### ä»»åŠ¡ 4: `updateUnreadBadges` è¢«è°ƒç”¨çš„ä½ç½®

åœ¨ `onMessageReceived` æ–¹æ³•ä¸­è¢«è°ƒç”¨ï¼š

```javascript
    async onMessageReceived(messageId) {
      try {
        // ... (ä»£ç çœç•¥)

        // æ›´æ–°æœªè¯»çº¢ç‚¹
        if (this.currentView === 'list') {
          this.updateUnreadBadges();
        }
      } catch (error) {
        console.error('[Message App] å¤„ç†æ¶ˆæ¯æ¥æ”¶äº‹ä»¶å¤±è´¥:', error);
      }
    }
```

**åˆ†æ**:
- è°ƒç”¨æ—¶æœºæ­£ç¡®ï¼šåœ¨æ¥æ”¶åˆ°æ–°æ¶ˆæ¯åï¼Œå¹¶ä¸”å½“å‰è§†å›¾æ˜¯å¥½å‹åˆ—è¡¨æ—¶ï¼Œä¼šè°ƒç”¨ `updateUnreadBadges`ã€‚
