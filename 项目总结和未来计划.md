# é¡¹ç›®æ€»ç»“å’Œæœªæ¥è®¡åˆ’

## ç»¼åˆè¯„ä¼°æŠ¥å‘Š

### 1. æ ¸å¿ƒæ¶æ„ï¼šè®¾è®¡ç²¾è‰¯ï¼Œé«˜åº¦æ¨¡å—åŒ–

è¯¥é¡¹ç›®é‡‡ç”¨äº†ä¸€ç§ç±»ä¼¼"å¾®å‰ç«¯"çš„æ¶æ„æ€æƒ³ï¼Œå°†æ•´ä¸ªæ‰‹æœºç•Œé¢è§†ä¸ºä¸€ä¸ª"æ“ä½œç³»ç»Ÿ"ï¼ˆç”± `mobile-phone.js` å®ç°ï¼‰ï¼Œè€Œå°†"ä¿¡æ¯"ã€"è®ºå›"ã€"å¾®åš"ç­‰åŠŸèƒ½å®ç°ä¸ºå¯ç‹¬ç«‹åŠ è½½çš„"å¾®åº”ç”¨"ã€‚

-   **åŒå±‚åŠ è½½æœºåˆ¶**ï¼š
    -   **å®è§‚åŠ è½½å™¨ (`optimized-loader.js`)**: è´Ÿè´£å¹¶è¡ŒåŠ è½½æ ¸å¿ƒæ¨¡å—ï¼Œé€šè¿‡ä¼˜å…ˆçº§åˆ’åˆ†å’Œå»¶è¿ŸåŠ è½½ï¼Œå®ç°äº†æå¿«çš„åˆå§‹å¯åŠ¨é€Ÿåº¦ã€‚
    -   **åº”ç”¨åŠ è½½å™¨ (`app-loader.js`)**: è´Ÿè´£åŠ è½½åº”ç”¨å†…éƒ¨çš„å­æ¨¡å—ï¼Œå¹¶ç®¡ç†å®ƒä»¬ä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼Œç¡®ä¿äº†ä»£ç æ‰§è¡Œçš„æ­£ç¡®æ€§å’Œç¨³å®šæ€§ã€‚
-   **åº”ç”¨æ³¨å†Œè¡¨**: `mobile-phone.js` ä¸­çš„ `registerApps` æ–¹æ³•å……å½“äº†"åº”ç”¨å•†åº—"çš„è§’è‰²ï¼Œæ–°åŠŸèƒ½å¯ä»¥åƒå®‰è£…Appä¸€æ ·ï¼Œé€šè¿‡æ³¨å†Œè½»æ¾é›†æˆåˆ°æ‰‹æœºæ¡Œé¢ï¼Œæ‰©å±•æ€§æå¼ºã€‚
-   **çŠ¶æ€ç®¡ç†**: é€šè¿‡å¯¼èˆªæ ˆï¼ˆ`appStack`ï¼‰å’ŒçŠ¶æ€å¯¹è±¡ï¼ˆ`currentAppState`ï¼‰ç®¡ç†é¡µé¢è·³è½¬å’ŒUIçŠ¶æ€ï¼Œå¹¶é€šè¿‡ä¸€ä¸ªå·§å¦™çš„çŠ¶æ€åŒæ­¥å¾ªç¯ï¼ˆ`startStateSyncLoop`ï¼‰ç¡®ä¿äº†å„æ¨¡å—é—´çŠ¶æ€çš„ä¸€è‡´æ€§ã€‚

### 2. ç¨³å®šæ€§åˆ†æ (é«˜)

å°½ç®¡é¡¹ç›®æœªä½¿ç”¨ç°ä»£å‰ç«¯æ¡†æ¶ï¼Œä½†å…¶ç¨³å®šæ€§éå¸¸é«˜ï¼Œä¸»è¦å¾—ç›Šäºä»¥ä¸‹å‡ ç‚¹ï¼š

-   **å¥å£®çš„åŠ è½½æœºåˆ¶**ï¼šåŠ è½½å™¨å…·å¤‡å®¹é”™å›é€€åŠŸèƒ½ï¼Œå¦‚æœä¼˜åŒ–åŠ è½½å¤±è´¥ï¼Œä¼šè‡ªåŠ¨åˆ‡æ¢åˆ°æ›´ç¨³å®šçš„ä¼ ç»ŸåŠ è½½æ¨¡å¼ã€‚
-   **äº‹ä»¶ä¸è½®è¯¢ç»“åˆ**ï¼šä¼˜å…ˆä½¿ç”¨ `SillyTavern` çš„åŸç”Ÿäº‹ä»¶ç›‘å¬æ–°æ¶ˆæ¯ï¼Œä¿è¯äº†å®æ—¶æ€§å’Œæ€§èƒ½ã€‚åœ¨äº‹ä»¶ç³»ç»Ÿä¸å¯ç”¨æ—¶ï¼Œä¼šè‡ªåŠ¨é™çº§ä¸ºè½®è¯¢æ¨¡å¼ï¼Œç¡®ä¿æ ¸å¿ƒåŠŸèƒ½ä¸ä¸­æ–­ã€‚
-   **é˜²å¾¡æ€§ç¼–ç¨‹**ï¼šä»£ç ä¸­å¤§é‡ä½¿ç”¨ `setTimeout` è¿›è¡Œå»¶è¿Ÿåˆå§‹åŒ–ã€æ£€æŸ¥ä¾èµ–æ˜¯å¦åŠ è½½å®Œæˆï¼Œæœ‰æ•ˆé¿å…äº†å› åŠ è½½é¡ºåºé—®é¢˜å¯¼è‡´çš„è¿è¡Œæ—¶é”™è¯¯ã€‚
-   **æ¨¡å—åŒ–éš”ç¦»**ï¼šæ¯ä¸ª"å¾®åº”ç”¨"ç›¸å¯¹ç‹¬ç«‹ï¼Œå•ä¸ªåº”ç”¨çš„bugå¾ˆéš¾å½±å“åˆ°æ•´ä¸ªæ’ä»¶çš„è¿è¡Œã€‚

### 3. å¯ä¿®æ”¹æ€§åˆ†æ (é«˜)

é¡¹ç›®çš„å¯ä¿®æ”¹æ€§éå¸¸å‡ºè‰²ï¼Œä¸»è¦ä½“ç°åœ¨ï¼š

-   **å…³æ³¨ç‚¹åˆ†ç¦»**ï¼šUIã€ä¸šåŠ¡é€»è¾‘å’Œæ•°æ®æ¸²æŸ“è¢«æ¸…æ™°åœ°åˆ†ç¦»åœ¨ä¸åŒçš„æ¨¡å—ä¸­ã€‚ä¾‹å¦‚ï¼Œä¿®æ”¹èŠå¤©æ°”æ³¡æ ·å¼åªéœ€å…³å¿ƒ `message-renderer.css`ï¼Œè€Œæ— éœ€è§¦ç¢°ä»»ä½•JavaScripté€»è¾‘ã€‚
-   **æ¸…æ™°çš„èŒè´£åˆ’åˆ†**ï¼š`mobile-phone.js` è´Ÿè´£æ¡†æ¶ï¼Œ`message-app.js` è´Ÿè´£åº”ç”¨é€»è¾‘ï¼Œ`message-renderer.js` è´Ÿè´£æ¸²æŸ“ã€‚è¿™ç§åˆ†å±‚ä½¿å¾—å®šä½å’Œä¿®æ”¹ä»£ç å˜å¾—ç®€å•ç›´è§‚ã€‚
-   **æ˜¾å¼ä¾èµ–ç®¡ç†**ï¼š`app-loader.js` ä¸­æ˜ç¡®å®šä¹‰äº†æ¨¡å—é—´çš„ä¾èµ–å…³ç³»ï¼Œä½¿å¾—åœ¨é‡æ„æˆ–ä¿®æ”¹æ—¶ï¼Œå¼€å‘è€…å¯ä»¥æ¸…æ™°åœ°äº†è§£æ”¹åŠ¨å¯èƒ½å¸¦æ¥çš„å½±å“ã€‚

### 4. æ–°å¢åŠŸèƒ½ä¾¿åˆ©æ€§ (æé«˜)

è¿™æ˜¯è¯¥é¡¹ç›®æ¶æ„æœ€å¤§çš„äº®ç‚¹ï¼Œä¸ºäºŒæ¬¡å¼€å‘æä¾›äº†æå¤§çš„ä¾¿åˆ©ã€‚

-   **"å³æ’å³ç”¨"çš„åº”ç”¨æ¨¡å¼**ï¼šå¼€å‘è€…å¯ä»¥å®Œå…¨ä»¿ç…§ `app/forum-app` æˆ– `app/weibo-app` çš„ç›®å½•ç»“æ„å’Œç¼–ç æ¨¡å¼ï¼Œå¿«é€Ÿå¼€å‘ä¸€ä¸ªå…¨æ–°çš„åŠŸèƒ½ã€‚
-   **æ¸…æ™°çš„é›†æˆè·¯å¾„**ï¼š
    1.  åœ¨ `app/` ç›®å½•ä¸‹åˆ›å»ºæ–°åº”ç”¨æ–‡ä»¶å¤¹ã€‚
    2.  ç¼–å†™åº”ç”¨çš„HTMLã€CSSå’ŒJSæ–‡ä»¶ã€‚
    3.  åœ¨ `mobile-phone.js` çš„ `registerApps` æ–¹æ³•ä¸­æ·»åŠ ä¸€è¡Œæ³¨å†Œä»£ç ï¼ŒæŒ‡å®šåº”ç”¨å›¾æ ‡å’ŒåŠ è½½å¤„ç†å™¨ã€‚
    4.  åœ¨ `index.js` çš„ `extensionModules` æ•°ç»„ä¸­æ·»åŠ æ–°åº”ç”¨çš„ä¸»è„šæœ¬ï¼Œä»¥ä¾¿è¢«é¡¶å±‚åŠ è½½å™¨åŠ è½½ã€‚
-   **ä¸°å¯Œçš„APIå’Œäº‹ä»¶**ï¼šé¡¹ç›®æš´éœ²äº†å¤§é‡çš„ `window.MobileContext` è°ƒè¯•æ¥å£ï¼Œå¹¶æ´¾å‘è‡ªå®šä¹‰äº‹ä»¶ï¼Œæ–¹ä¾¿æ–°åŠŸèƒ½ä¸ç°æœ‰ç³»ç»Ÿè¿›è¡Œäº¤äº’ã€‚

## æœªæ¥è®¡åˆ’ä¸æ”¹è¿›å»ºè®®

åŸºäºå½“å‰ä¼˜ç§€çš„æ¶æ„ï¼Œæœªæ¥å¯ä»¥ä»ä»¥ä¸‹å‡ ä¸ªæ–¹é¢è¿›è¡Œå¢å¼ºï¼š

1.  **æ„å»ºå·¥å…·å¼•å…¥ (å¯é€‰)**:
    *   **å»ºè®®**: å¼•å…¥åƒ Vite æˆ– Webpack è¿™æ ·çš„ç°ä»£æ„å»ºå·¥å…·ã€‚
    *   **ä¼˜åŠ¿**:
        *   å¯ä»¥ä»å…¨å±€å˜é‡ä¾èµ–ï¼ˆ`window.xxx`ï¼‰è½¬å‘çœŸæ­£çš„ ES æ¨¡å—å¯¼å…¥/å¯¼å‡ºï¼ˆ`import/export`ï¼‰ï¼Œå½»åº•è§£å†³æ½œåœ¨çš„å…¨å±€å‘½åç©ºé—´æ±¡æŸ“é—®é¢˜ã€‚
        *   å¯ä»¥è‡ªåŠ¨å¤„ç†ä¾èµ–å…³ç³»ï¼Œä¸å†éœ€è¦æ‰‹åŠ¨ç»´æŠ¤åŠ è½½é¡ºåºå’Œ `setTimeout` å»¶è¿Ÿã€‚
        *   å¯ä»¥å®ç°ä»£ç å‹ç¼©ã€æ··æ·†å’Œæ‰“åŒ…ï¼Œå‡å°æœ€ç»ˆæ–‡ä»¶ä½“ç§¯ï¼Œæå‡åŠ è½½æ€§èƒ½ã€‚
        *   å¯ä»¥ä½¿ç”¨ TypeScript æ¥å¢å¼ºä»£ç çš„ç±»å‹å®‰å…¨å’Œå¯ç»´æŠ¤æ€§ã€‚

2.  **çŠ¶æ€ç®¡ç†åº“**:
    *   **å»ºè®®**: å¼•å…¥ä¸€ä¸ªè½»é‡çº§çš„çŠ¶æ€ç®¡ç†åº“ï¼Œå¦‚ astate æˆ– zustandï¼Œæ¥æ›¿ä»£ç›®å‰çš„çŠ¶æ€åŒæ­¥å¾ªç¯ï¼ˆ`startStateSyncLoop`ï¼‰ã€‚
    *   **ä¼˜åŠ¿**: å¯ä»¥æä¾›ä¸€ä¸ªæ›´æ˜ç¡®ã€æ›´å“åº”å¼çš„çŠ¶æ€æ›´æ–°æ¨¡å¼ï¼Œå‡å°‘æ‰‹åŠ¨åŒæ­¥çŠ¶æ€çš„å¤æ‚æ€§ã€‚

3.  **ç»„ä»¶åŒ–é‡æ„**:
    *   **å»ºè®®**: å°† `mobile-phone.js` ä¸­å·¨å¤§çš„HTMLæ¨¡æ¿å­—ç¬¦ä¸²ï¼Œä»¥åŠå„ä¸ªåº”ç”¨ä¸­çš„HTMLç”Ÿæˆé€»è¾‘ï¼Œé‡æ„ä¸ºæ›´å°çš„ã€å¯å¤ç”¨çš„ç»„ä»¶å‡½æ•°æˆ–ç±»ã€‚
    *   **ä¼˜åŠ¿**: æé«˜UIä»£ç çš„å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚ä¾‹å¦‚ï¼Œå¯ä»¥åˆ›å»ºä¸€ä¸ª `Button` ç»„ä»¶æˆ– `Panel` ç»„ä»¶ã€‚

4.  **æ–‡æ¡£å®Œå–„**:
    *   **å»ºè®®**: ä¸ºäºŒæ¬¡å¼€å‘è€…ç¼–å†™ä¸€ä»½æ›´è¯¦ç»†çš„å¼€å‘æŒ‡å—ï¼Œè¯´æ˜å¦‚ä½•åˆ›å»ºä¸€ä¸ªæ–°çš„"å¾®åº”ç”¨"ï¼Œä»¥åŠå¦‚ä½•ä½¿ç”¨é¡¹ç›®ä¸­æš´éœ²çš„å„ç§APIå’Œäº‹ä»¶ã€‚
    *   **ä¼˜åŠ¿**: é™ä½æ–°å¼€å‘è€…çš„ä¸Šæ‰‹é—¨æ§›ï¼Œä¿ƒè¿›ç¤¾åŒºè´¡çŒ®ã€‚

### æ€»ç»“

è¿™æ˜¯ä¸€ä¸ªåœ¨åŸç”ŸJavaScriptç¯å¢ƒä¸‹æ„å»ºçš„ã€å ªç§°å…¸èŒƒçš„å‰ç«¯é¡¹ç›®ã€‚å®ƒé€šè¿‡ä¼˜ç§€çš„æ¶æ„è®¾è®¡ï¼Œå¼¥è¡¥äº†æ²¡æœ‰ç°ä»£æ¡†æ¶æ‰€å¸¦æ¥çš„ä¸è¶³ï¼Œå®ç°äº†**é«˜ç¨³å®šæ€§ã€é«˜å¯ç»´æŠ¤æ€§ã€é«˜æ‰©å±•æ€§**çš„ç›®æ ‡ã€‚æ— è®ºæ˜¯æƒ³ä¿®æ”¹ç°æœ‰åŠŸèƒ½ï¼Œè¿˜æ˜¯å¢åŠ å…¨æ–°çš„ä¸ªæ€§åŒ–åº”ç”¨ï¼Œè¿™ä¸ªé¡¹ç›®éƒ½æä¾›äº†æå…¶ä¾¿åˆ©çš„æ¡ä»¶ã€‚å¯¹äºä»»ä½•æƒ³åœ¨æ­¤åŸºç¡€ä¸Šè¿›è¡ŒäºŒæ¬¡å¼€å‘çš„å¼€å‘è€…æ¥è¯´ï¼Œè¿™éƒ½æ˜¯ä¸€ä¸ªç†æƒ³çš„èµ·ç‚¹ã€‚

---

## ç¬¬äºŒAPIé›†æˆæ–¹æ¡ˆ - æ™ºèƒ½å†…å®¹ç”Ÿæˆä¸æ’å…¥ç³»ç»Ÿ

### ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

æœ¬æ–¹æ¡ˆå°†åˆ›å»ºä¸€ä¸ªå…¨æ–°çš„APIé›†æˆç³»ç»Ÿï¼Œå®ç°AIç”Ÿæˆå†…å®¹çš„è‡ªåŠ¨æ’å…¥åŠŸèƒ½ï¼Œå®Œå…¨åœ¨æ‰‹æœºç•Œé¢å†…è¿è¡Œï¼Œä¸å†ä¾èµ–é…’é¦†ä¸–ç•Œä¹¦å’Œå¤–éƒ¨APIé…ç½®ã€‚

### ğŸ¯ æ ¸å¿ƒç›®æ ‡

1. **ç‹¬ç«‹è¿è¡Œ**: å®Œå…¨åœ¨æ‰‹æœºç•Œé¢å†…å®Œæˆï¼Œä¸éœ€è¦é€šè¿‡é…’é¦†ä¸–ç•Œä¹¦
2. **æ™ºèƒ½ç”Ÿæˆ**: ä½¿ç”¨ç¬¬äºŒä¸ªAPIè‡ªåŠ¨ç”Ÿæˆæ‰‹æœºç›¸å…³å†…å®¹ï¼ˆæ¶ˆæ¯ã€æœ‹å‹åœˆã€å•†å“ç­‰ï¼‰
3. **å†…è”æ’å…¥**: é‡‡ç”¨å†…è”æ¨¡å¼ï¼Œå°†ç”Ÿæˆçš„å†…å®¹ä½œä¸ºé™„ä»¶æ·»åŠ åˆ°æ¶ˆæ¯ä¸­
4. **å‡è½»è´Ÿæ‹…**: åˆ†æ‹…é…’é¦†ä¸»APIçš„å‹åŠ›ï¼Œæå‡æ•´ä½“æ€§èƒ½

### ğŸ“ æŠ€æœ¯æ¶æ„

#### 1. æ ¸å¿ƒæ¨¡å—ï¼šmobile-api-integration.js

```
mobile-api-integration.js
â”œâ”€â”€ MobileAPIIntegration (ä¸»ç±»)
â”‚   â”œâ”€â”€ é…ç½®ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ åŠ è½½/ä¿å­˜è®¾ç½®
â”‚   â”‚   â””â”€â”€ APIé…ç½®ï¼ˆå¤ç”¨custom-api-config.jsï¼‰
â”‚   â”œâ”€â”€ æç¤ºè¯æ³¨å…¥ç³»ç»Ÿ
â”‚   â”‚   â”œâ”€â”€ æç¤ºè¯æ¨¡æ¿ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ åŠ¨æ€æ³¨å…¥ç­–ç•¥
â”‚   â”‚   â””â”€â”€ ä¸Šä¸‹æ–‡åˆ†æ
â”‚   â”œâ”€â”€ å†…å®¹è§£æå™¨
â”‚   â”‚   â”œâ”€â”€ æ­£åˆ™è¡¨è¾¾å¼å¼•æ“
â”‚   â”‚   â”œâ”€â”€ æ ¼å¼è¯†åˆ«
â”‚   â”‚   â””â”€â”€ å†…å®¹æå–
â”‚   â””â”€â”€ å†…å®¹æ’å…¥å™¨
â”‚       â”œâ”€â”€ å†…è”æ¨¡å¼å®ç°
â”‚       â”œâ”€â”€ æ¶ˆæ¯extraå­—æ®µå¤„ç†
â”‚       â””â”€â”€ UIæ›´æ–°ç®¡ç†
```

#### 2. å·¥ä½œæµç¨‹

```
ç”¨æˆ·å‘é€æ¶ˆæ¯
    â†“
æ£€æµ‹æ˜¯å¦éœ€è¦ç”Ÿæˆæ‰‹æœºå†…å®¹
    â†“
è‡ªåŠ¨æ³¨å…¥æç¤ºè¯åˆ°APIè¯·æ±‚
    â†“
è°ƒç”¨ç¬¬äºŒAPIç”Ÿæˆå†…å®¹
    â†“
è§£æè¿”å›çš„æ ¼å¼åŒ–å†…å®¹
    â†“
å°†å†…å®¹ä½œä¸ºé™„ä»¶æ’å…¥åˆ°æ¶ˆæ¯
    â†“
æ›´æ–°æ‰‹æœºç•Œé¢æ˜¾ç¤º
```

### ğŸ“ è¯¦ç»†å®ç°æ­¥éª¤

#### é˜¶æ®µ1: åŸºç¡€æ¶æ„æ­å»º (é¢„è®¡2å°æ—¶)

**ä»»åŠ¡æ¸…å•:**
- [x] åˆ›å»º `mobile-api-integration.js` æ–‡ä»¶
- [ ] å®šä¹‰ `MobileAPIIntegration` ä¸»ç±»
- [ ] å®ç°é…ç½®åŠ è½½/ä¿å­˜åŠŸèƒ½
- [ ] é›†æˆ `custom-api-config.js` çš„APIè°ƒç”¨èƒ½åŠ›
- [ ] åˆ›å»ºåŸºç¡€UIé…ç½®é¢æ¿

**æŠ€æœ¯ç»†èŠ‚:**
```javascript
class MobileAPIIntegration {
    constructor() {
        this.apiConfig = window.mobileCustomAPIConfig;
        this.settings = this.loadSettings();
        this.promptTemplates = this.loadPromptTemplates();
    }
    
    // é…ç½®é»˜è®¤å€¼
    getDefaultSettings() {
        return {
            enabled: false,
            insertMode: 'inline', // inline/replace/new
            autoDetect: true,
            promptTemplate: 'æ‰‹æœºä¸–ç•Œä¹¦æç¤ºè¯',
            targetFormats: [
                'å¯¹æ–¹æ¶ˆæ¯', 'ç¾¤èŠæ¶ˆæ¯', 'æœ‹å‹åœˆ', 
                'å•†å“', 'ä»»åŠ¡', 'ç›´æ’­', 'èƒŒåŒ…'
            ]
        };
    }
}
```

#### é˜¶æ®µ2: æç¤ºè¯æ³¨å…¥ç³»ç»Ÿ (é¢„è®¡3å°æ—¶)

**ä»»åŠ¡æ¸…å•:**
- [ ] ä»ä¸–ç•Œä¹¦JSONæå–æç¤ºè¯æ¨¡æ¿
- [ ] å®ç°æç¤ºè¯æ¨¡æ¿ç®¡ç†å™¨
- [ ] å¼€å‘ä¸Šä¸‹æ–‡åˆ†æå™¨ï¼ˆåˆ¤æ–­ä½•æ—¶éœ€è¦ç”Ÿæˆæ‰‹æœºå†…å®¹ï¼‰
- [ ] å®ç°åŠ¨æ€æç¤ºè¯æ³¨å…¥é€»è¾‘

**æç¤ºè¯æ¨¡æ¿ç¤ºä¾‹:**
```javascript
const promptTemplates = {
    // ä»å¤–ç½®æ‰‹æœºä¸–ç•Œä¹¦.jsonæå–
    phoneGeneral: `
# æ‰‹æœºç³»ç»Ÿè§„åˆ™
è§’è‰²ä¼šä¸»åŠ¨ç»™ç”¨æˆ·å‘é€ä¿¡æ¯ï¼Œå¯èƒ½æ˜¯ç§èŠæˆ–ç¾¤èŠã€‚
è§’è‰²ä¼šä¸»åŠ¨å‘æœ‹å‹åœˆï¼ŒåŒ…æ‹¬æ–‡å­—æœ‹å‹åœˆæˆ–è§†è§‰æœ‹å‹åœˆã€‚
æ‰€æœ‰çº¿ä¸Šè¾“å‡ºå¿…é¡»æŒ‰ç…§æ ¼å¼...
    `,
    
    privateMessage: `
# ç§èŠæ¶ˆæ¯æ ¼å¼
[å¯¹æ–¹æ¶ˆæ¯|{{å¯¹æ–¹åå­—}}|{{å¯¹æ–¹å¥½å‹id}}|{{æ¶ˆæ¯ç±»å‹}}|{{æ¶ˆæ¯å†…å®¹}}]
    `,
    
    moments: `
# æœ‹å‹åœˆæ ¼å¼
[æœ‹å‹åœˆ|{{è§’è‰²åå­—}}|{{è§’è‰²å¥½å‹id}}|{{æ¥¼å±‚id}}|{{å†…å®¹}}]
    `
};
```

**ä¸Šä¸‹æ–‡æ£€æµ‹é€»è¾‘:**
```javascript
detectPhoneContentNeed(context) {
    // æ£€æµ‹å…³é”®è¯
    const keywords = ['æ‰‹æœº', 'æ¶ˆæ¯', 'æœ‹å‹åœˆ', 'ç¾¤èŠ', 'æ·˜å®', 'ç›´æ’­'];
    const hasKeyword = keywords.some(kw => context.includes(kw));
    
    // æ£€æµ‹æœ€è¿‘æ¶ˆæ¯ç±»å‹
    const recentMessages = this.getRecentMessages(5);
    const hasPhoneFormat = recentMessages.some(msg => 
        /\[å¯¹æ–¹æ¶ˆæ¯|.*?\]|\[æœ‹å‹åœˆ|.*?\]/.test(msg)
    );
    
    return hasKeyword || hasPhoneFormat;
}
```

#### é˜¶æ®µ3: å†…å®¹è§£æå™¨ (é¢„è®¡2å°æ—¶)

**ä»»åŠ¡æ¸…å•:**
- [ ] å®ç°å¤šæ ¼å¼æ­£åˆ™è¡¨è¾¾å¼è§£æå™¨
- [ ] å¼€å‘æ ¼å¼éªŒè¯å™¨
- [ ] åˆ›å»ºå†…å®¹æå–å™¨
- [ ] å®ç°é”™è¯¯å¤„ç†å’Œé™çº§ç­–ç•¥

**è§£æå™¨å®ç°:**
```javascript
class ContentParser {
    constructor() {
        this.patterns = {
            privateMessage: /\[å¯¹æ–¹æ¶ˆæ¯\|(.*?)\|(.*?)\|(.*?)\|(.*?)\]/g,
            groupMessage: /\[ç¾¤èŠæ¶ˆæ¯\|(.*?)\|(.*?)\|(.*?)\|(.*?)\]/g,
            moments: /\[æœ‹å‹åœˆ\|(.*?)\|(.*?)\|(.*?)\|(.*?)\]/g,
            product: /\[å•†å“\|(.*?)\|(.*?)\|(.*?)\|(.*?)\]/g,
            task: /\[ä»»åŠ¡\|(.*?)\|(.*?)\|(.*?)\|(.*?)\|(.*?)\]/g,
            live: /\[ç›´æ’­\|(.*?)\|(.*?)\]/g,
            friendId: /\[å¥½å‹id\|(.*?)\|(.*?)\]/g
        };
    }
    
    parseContent(text) {
        const results = [];
        
        for (const [type, pattern] of Object.entries(this.patterns)) {
            let match;
            while ((match = pattern.exec(text)) !== null) {
                results.push({
                    type: type,
                    raw: match[0],
                    data: this.extractData(type, match)
                });
            }
        }
        
        return results;
    }
    
    extractData(type, match) {
        // æ ¹æ®ä¸åŒç±»å‹æå–æ•°æ®
        switch(type) {
            case 'privateMessage':
                return {
                    name: match[1],
                    id: match[2],
                    msgType: match[3],
                    content: match[4]
                };
            case 'moments':
                return {
                    name: match[1],
                    id: match[2],
                    postId: match[3],
                    content: match[4]
                };
            // ... å…¶ä»–æ ¼å¼
        }
    }
}
```

#### é˜¶æ®µ4: å†…è”æ’å…¥å™¨ (é¢„è®¡3å°æ—¶)

**ä»»åŠ¡æ¸…å•:**
- [ ] å®ç°å†…è”æ¨¡å¼æ’å…¥é€»è¾‘
- [ ] å¼€å‘æ¶ˆæ¯extraå­—æ®µç®¡ç†å™¨
- [ ] åˆ›å»ºUIæ›´æ–°å™¨
- [ ] å®ç°ä¸ç°æœ‰æ‰‹æœºåº”ç”¨çš„é›†æˆ

**æ’å…¥å™¨å®ç°:**
```javascript
class InlineInserter {
    async insertContent(message, parsedContents) {
        // åˆå§‹åŒ–message.extra
        if (!message.extra) {
            message.extra = {};
        }
        
        // åˆå§‹åŒ–æ‰‹æœºå†…å®¹æ•°ç»„
        if (!message.extra.phoneContents) {
            message.extra.phoneContents = [];
        }
        
        // æ·»åŠ è§£æçš„å†…å®¹
        for (const content of parsedContents) {
            message.extra.phoneContents.push({
                type: content.type,
                data: content.data,
                timestamp: Date.now()
            });
        }
        
        // æ ‡è®°ä¸ºåŒ…å«æ‰‹æœºå†…å®¹
        message.extra.hasPhoneContent = true;
        
        // æ›´æ–°UIæ˜¾ç¤º
        await this.updateMessageDisplay(message);
        
        // ä¿å­˜èŠå¤©è®°å½•
        await this.saveChat();
        
        // è§¦å‘æ‰‹æœºåº”ç”¨æ›´æ–°
        this.notifyPhoneApps(parsedContents);
    }
    
    updateMessageDisplay(message) {
        // åœ¨æ¶ˆæ¯å—ä¸­æ·»åŠ "æŸ¥çœ‹æ‰‹æœºå†…å®¹"æŒ‰é’®
        const messageElement = $(`.mes[mesid="${message.index}"]`);
        
        if (message.extra.hasPhoneContent) {
            const phoneButton = $(`
                <div class="phone-content-indicator">
                    <button class="view-phone-content-btn">
                        ğŸ“± æŸ¥çœ‹æ‰‹æœºå†…å®¹ (${message.extra.phoneContents.length})
                    </button>
                </div>
            `);
            
            phoneButton.on('click', () => {
                this.showPhoneContentModal(message);
            });
            
            messageElement.find('.mes_text').after(phoneButton);
        }
    }
    
    notifyPhoneApps(contents) {
        // é€šçŸ¥å„ä¸ªæ‰‹æœºåº”ç”¨æœ‰æ–°å†…å®¹
